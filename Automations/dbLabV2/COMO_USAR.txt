================================================================================
                    SISTEMA DE COLETA SODRE - GUIA DE USO
================================================================================

üìã DESCRI√á√ÉO
------------
Script automatizado para coletar dados de laborat√≥rios credenciados do Sodre,
processar churn (credenciamentos/descredenciamentos) e gerar relat√≥rios em Excel.

üñ•Ô∏è  DETEC√á√ÉO AUTOM√ÅTICA DE M√ÅQUINA
-----------------------------------
O script detecta automaticamente em qual computador est√° rodando e ajusta:
- Diret√≥rio de salvamento
- N√∫mero de threads (otimizado para cada processador)

M√ÅQUINAS SUPORTADAS:
  
  ‚úì PC CASA (Ryzen 7 7500X - 6 cores / 12 threads)
    - Username: washi
    - Diret√≥rio: D:\OneDrive - Synvia Group\Data Analysis\Churn PCLs\Automations\cunha
    - Threads padr√£o: 16 (otimizado para I/O bound)
    
  ‚úì NOTEBOOK SYNVIA (Intel i7-1165G7 - 4 cores / 8 threads)
    - Username: washington.gouvea  
    - Diret√≥rio: C:\Users\washington.gouvea\OneDrive - Synvia Group\Data Analysis\Churn PCLs\Automations\cunha
    - Threads padr√£o: 8 (todos os threads l√≥gicos)

A detec√ß√£o √© autom√°tica baseada no username/hostname do Windows.

üîß COMANDOS DISPON√çVEIS
-----------------------

1. EXECU√á√ÉO NORMAL (Coleta di√°ria)
   python Automations/cunha/dbLabV2.py
   
   O que faz:
   - Se arquivo do dia N√ÉO existe: Faz coleta completa (~27 minutos)
   - Se arquivo do dia EXISTE e n√£o foi processado: Processa churn e relat√≥rios
   - Se j√° foi processado (flag existe): Pula tudo

2. FOR√áAR REPROCESSAMENTO
   python Automations/cunha/dbLabV2.py --force
   
   O que faz:
   - Remove flag de processamento
   - Reprocessa churn e relat√≥rios do arquivo do dia
   - √ötil se houve erro ou quer atualizar relat√≥rios

3. APENAS GERAR RELAT√ìRIOS
   python Automations/cunha/dbLabV2.py --gerar-relatorio
   
   O que faz:
   - Carrega CSV existente
   - Gera/atualiza relat√≥rios Excel
   - N√£o faz coleta nova

4. MODO DAEMON (Autom√°tico - RECOMENDADO)
   python Automations/cunha/dbLabV2.py --daemon
   
   O que faz:
   - Executa automaticamente √†s 23:00 todos os dias
   - Coleta todos os credenciamentos do dia completo
   - Roda em background cont√≠nuo
   
   IMPORTANTE: Mantenha o terminal/PowerShell aberto ou configure como servi√ßo

5. PERSONALIZAR THREADS
   python Automations/cunha/dbLabV2.py --threads=24
   
   O que faz:
   - Define n√∫mero de threads para coleta paralela
   - Padr√£o: 16 threads
   - Mais threads = mais r√°pido (mas mais carga no sistema)

üìä ARQUIVOS GERADOS
-------------------

1. dados_YYYY-MM-DD.csv
   - Dados brutos da coleta di√°ria
   - Cont√©m todos os laborat√≥rios encontrados
   - Inclui colunas de pre√ßos extra√≠dos

2. churn_YYYY-MM-DD.xlsx
   - Credenciamentos e descredenciamentos do dia
   - Compara√ß√£o com dia anterior

3. relatorio_completo_laboratorios_sodre.xlsx
   - Aba "Dados Completos": Todos os labs com pre√ßos
   - Aba "EntradaSaida": Hist√≥rico de movimenta√ß√µes (apenas credenciamentos/descredenciamentos reais)
   - Aba "Resumo Geogr√°fico": Distribui√ß√£o por estado
   - Aba "Resumo Credenciamentos": Timeline de movimenta√ß√µes

4. .pipeline_completo_YYYY-MM-DD.flag
   - Arquivo de controle (N√ÉO deletar manualmente)
   - Indica que processamento foi conclu√≠do
   - Evita reprocessamento duplicado

üìÅ LOCALIZA√á√ÉO DOS ARQUIVOS
---------------------------
D:\OneDrive - Synvia Group\Data Analysis\Churn PCLs\Automations\cunha\

üîÑ FLUXO DE EXECU√á√ÉO
--------------------

CEN√ÅRIO 1: Primeira execu√ß√£o do dia (sem arquivo)
  1. Faz coleta completa (5.526 munic√≠pios)
  2. Extrai pre√ßos de todos os laborat√≥rios
  3. Salva CSV
  4. Processa churn (compara com dia anterior)
  5. Atualiza todas as abas do Excel
  6. Cria arquivo .flag

CEN√ÅRIO 2: Arquivo do dia existe, mas n√£o foi processado (sem .flag)
  1. Carrega CSV existente
  2. Processa churn
  3. Atualiza todas as abas do Excel
  4. Cria arquivo .flag

CEN√ÅRIO 3: J√° foi processado (arquivo .flag existe)
  1. Detecta que j√° foi executado
  2. Pula tudo
  3. Mostra mensagem informativa

‚öôÔ∏è CONFIGURA√á√ÉO AUTOM√ÅTICA (RECOMENDADO)
-----------------------------------------

OP√á√ÉO 1: Executar manualmente √†s 23h
  - Abrir PowerShell √†s 23:00
  - Executar: python Automations/cunha/dbLabV2.py --daemon

OP√á√ÉO 2: Agendador de Tarefas do Windows
  1. Abrir "Agendador de Tarefas"
  2. Criar nova tarefa
  3. Disparador: Diariamente √†s 23:00
  4. A√ß√£o: Executar programa
     - Programa: C:\Users\washi\AppData\Local\Programs\Python\Python312\python.exe
     - Argumentos: F:\Progama√ß√£o\ChurnAi\Automations\cunha\dbLabV2.py
     - Iniciar em: F:\Progama√ß√£o\ChurnAi
  5. Marcar: "Executar independentemente de usu√°rio estar conectado"

OP√á√ÉO 3: Usar modo daemon
  - PowerShell: python Automations/cunha/dbLabV2.py --daemon
  - Manter terminal aberto
  - Executar√° √†s 23:00 automaticamente

üêõ SOLU√á√ÉO DE PROBLEMAS
------------------------

PROBLEMA: "Pipeline j√° foi executado"
SOLU√á√ÉO: Use --force para reprocessar
  python Automations/cunha/dbLabV2.py --force

PROBLEMA: Pre√ßos vazios no Excel
SOLU√á√ÉO: 
  1. Deletar arquivo do dia: del dados_YYYY-MM-DD.csv
  2. Deletar flag: del .pipeline_completo_YYYY-MM-DD.flag
  3. Executar novamente

PROBLEMA: Erro de conex√£o com API
SOLU√á√ÉO: 
  1. Verificar conex√£o com internet
  2. Verificar se API do Sodre est√° acess√≠vel: https://li-sodretox-af-cidades.azurewebsites.net/api/BuscarPostos
  3. Tentar novamente ap√≥s alguns minutos

PROBLEMA: Coleta muito lenta
SOLU√á√ÉO: Aumentar threads
  python Automations/cunha/dbLabV2.py --threads=24

üìù LOGS
-------
Arquivo: D:\OneDrive - Synvia Group\Data Analysis\Churn PCLs\Automations\cunha\logs.txt
- Cont√©m hist√≥rico detalhado de todas as execu√ß√µes
- √ötil para debugging
- Cresce automaticamente (monitorar tamanho)

‚ö†Ô∏è IMPORTANTE
-------------
1. NUNCA commitar arquivo .env (cont√©m keys secretas)
2. Executar SOMENTE √†s 23h para capturar dia completo
3. N√ÉO deletar arquivos .flag manualmente (usar --force)
4. Manter backups dos arquivos Excel gerados
5. Monitorar espa√ßo em disco (arquivos CSV podem crescer)

üìû SUPORTE
----------
- Verificar logs.txt para erros detalhados
- Usar --force para reprocessamento
- Em caso de d√∫vidas, verificar c√≥digo em dbLabV2.py

================================================================================
√öltima atualiza√ß√£o: 2025-11-13
Vers√£o do script: 2.0
================================================================================

